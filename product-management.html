<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - D'Xpress Admin</title>
    <meta name="description" content="Advanced product management system for D'Xpress with enterprise-grade CRUD operations, bulk actions, and analytics">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236D28D9'%3e%3cpath d='M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z'/%3e%3c/svg%3e">
</head>
<body>
    <!-- Header Navigation -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <a href="index.html" class="logo">D'Xpress Admin</a>
                
                <!-- Navigation Menu -->
                <nav class="nav" id="desktopNav">
                    <a href="admin.html" class="nav-link">Dashboard</a>
                    <a href="product-management.html" class="nav-link active">Products</a>
                    <a href="orders.html" class="nav-link">Orders</a>
                    <a href="users.html" class="nav-link admin-only">Users</a>
                    <a href="analytics.html" class="nav-link vendor-only">Analytics</a>
                </nav>
                
                <!-- Header Actions -->
                <div class="header-actions">
                    <!-- Theme Toggle -->
                    <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="user-menu">
                        <div class="user-info" style="display: none;">
                            <img src="" alt="User Avatar" class="user-avatar" width="32" height="32">
                            <span class="user-name"></span>
                            <div class="user-dropdown">
                                <a href="dashboard.html">User Dashboard</a>
                                <a href="profile.html">Profile</a>
                                <a href="#" onclick="logoutUser()">Logout</a>
                            </div>
                        </div>
                        <div class="guest-only">
                            <a href="login.html" class="btn btn-primary">Login</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="section">
            <div class="container">
                <!-- Page Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h1>Product Management</h1>
                        <p class="text-secondary">Enterprise-grade product CRUD operations with bulk actions</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportProducts('csv')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export CSV
                        </button>
                        <button class="btn btn-secondary" onclick="exportProducts('json')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export JSON
                        </button>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Product
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-4" style="margin-bottom: 32px;">
                    <div class="card text-center">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary-500);" id="totalProducts">12</div>
                        <div class="text-secondary">Total Products</div>
                    </div>
                    <div class="card text-center">
                        <div style="font-size: 32px; font-weight: 700; color: var(--success-500);" id="activeProducts">12</div>
                        <div class="text-secondary">Active Products</div>
                    </div>
                    <div class="card text-center">
                        <div style="font-size: 32px; font-weight: 700; color: var(--warning-500);" id="lowStockProducts">3</div>
                        <div class="text-secondary">Low Stock</div>
                    </div>
                    <div class="card text-center">
                        <div style="font-size: 32px; font-weight: 700; color: var(--error-500);" id="outOfStockProducts">0</div>
                        <div class="text-secondary">Out of Stock</div>
                    </div>
                </div>

                <!-- Search and Filter Bar -->
                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px;">
                            <input 
                                type="text" 
                                class="form-input" 
                                id="productSearch"
                                placeholder="Search products by name, category, or SKU..."
                                oninput="filterProducts()"
                            >
                        </div>
                        
                        <select class="filter-select" id="categoryFilter" onchange="filterProducts()">
                            <option value="">All Categories</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home & Living">Home & Living</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                        
                        <select class="filter-select" id="statusFilter" onchange="filterProducts()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                        
                        <select class="filter-select" id="sortFilter" onchange="filterProducts()">
                            <option value="name">Sort by Name</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="stock">Stock Level</option>
                            <option value="rating">Rating</option>
                            <option value="date">Date Added</option>
                        </select>
                        
                        <button class="btn btn-ghost btn-sm" onclick="clearFilters()">Clear</button>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div id="bulkActions" style="margin-top: 16px; padding: 12px; background-color: var(--primary-500); color: white; border-radius: var(--border-radius-sm); display: none; justify-content: space-between; align-items: center;">
                        <span id="selectedCount">0 products selected</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-ghost btn-sm" onclick="bulkDelete()" style="color: white; border-color: rgba(255,255,255,0.3);">
                                Delete Selected
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="bulkExport()" style="color: white; border-color: rgba(255,255,255,0.3);">
                                Export Selected
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="clearSelection()" style="color: white; border-color: rgba(255,255,255,0.3);">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card" style="overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background-color: var(--neutral-800);">
                                <tr>
                                    <th style="padding: 12px; text-align: left; width: 40px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="padding: 12px; text-align: left;">Product</th>
                                    <th style="padding: 12px; text-align: left;">Category</th>
                                    <th style="padding: 12px; text-align: left;">Price</th>
                                    <th style="padding: 12px; text-align: left;">Stock</th>
                                    <th style="padding: 12px; text-align: left;">Rating</th>
                                    <th style="padding: 12px; text-align: left;">Status</th>
                                    <th style="padding: 12px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be dynamically loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px;">
                    <!-- Pagination will be dynamically generated -->
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 id="modalTitle">Add Product</h3>
                <button class="icon-btn" onclick="closeProductModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="grid grid-cols-2" style="gap: 16px;">
                    <div class="form-group">
                        <label for="productName" class="form-label">Product Name *</label>
                        <input type="text" id="productName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productCategory" class="form-label">Category *</label>
                        <select id="productCategory" class="form-select" required>
                            <option value="">Select Category</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home & Living">Home & Living</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription" class="form-label">Description *</label>
                    <textarea id="productDescription" class="form-textarea" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productFeatures" class="form-label">Features (one per line)</label>
                    <textarea id="productFeatures" class="form-textarea" rows="3" placeholder="Feature 1&#10;Feature 2&#10;Feature 3"></textarea>
                </div>
                
                <div class="grid grid-cols-3" style="gap: 16px;">
                    <div class="form-group">
                        <label for="productPrice" class="form-label">Price (USD) *</label>
                        <input type="number" id="productPrice" class="form-input" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productStock" class="form-label">Stock *</label>
                        <input type="number" id="productStock" class="form-input" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productRating" class="form-label">Rating</label>
                        <input type="number" id="productRating" class="form-input" min="0" max="5" step="0.1" value="4.0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productImage" class="form-label">Image URL</label>
                    <input type="url" id="productImage" class="form-input" placeholder="https://example.com/image.jpg">
                </div>
                
                <!-- Image Upload -->
                <div class="form-group">
                    <label class="form-label">Upload Image</label>
                    <div id="imageUpload" style="border: 2px dashed var(--neutral-400); border-radius: var(--border-radius-sm); padding: 32px; text-align: center; cursor: pointer;" onclick="document.getElementById('imageFile').click()">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 16px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21,15 16,10 5,21"/>
                        </svg>
                        <p class="text-secondary">Click to upload image or drag and drop</p>
                        <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    </div>
                    <div id="imagePreview" style="margin-top: 16px; display: none;">
                        <img id="previewImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: var(--border-radius-sm);">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">
                        <span id="saveBtnText">Save Product</span>
                        <div id="saveBtnLoading" class="loading" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="deleteModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 400px; width: 90%; margin: 20px;">
            <div style="text-align: center;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--error-500)" stroke-width="1" style="margin: 0 auto 16px;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <h3>Confirm Delete</h3>
                <p class="text-secondary" style="margin-bottom: 24px;">Are you sure you want to delete this product? This action cannot be undone.</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn btn-error" onclick="confirmDelete()">Delete Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background-color: var(--neutral-900); padding: 48px 0; margin-top: 64px;">
        <div class="container">
            <div style="text-align: center;">
                <p class="text-secondary">&copy; 2025 D'Xpress. Built by MiniMax Agent. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/script.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Product Management System
        let products = [...getProducts()];
        let filteredProducts = [];
        let selectedProducts = new Set();
        let currentPage = 1;
        const itemsPerPage = 10;
        let editingProductId = null;

        // Initialize product management
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication and permissions
            if (!isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            if (!hasPermission('manage_products')) {
                showAccessDenied('Product management requires vendor or admin access');
                return;
            }

            initializeProductManagement();
            
            trackEvent('product_management_opened', {
                user: currentUser.email,
                role: currentUser.role
            });
        });

        // Initialize product management system
        function initializeProductManagement() {
            loadProducts();
            updateStatistics();
        }

        // Load and display products
        function loadProducts() {
            filteredProducts = [...products];
            displayProducts();
            updatePagination();
        }

        // Display products in table
        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageProducts.map(product => `
                <tr style="border-bottom: 1px solid var(--neutral-800);">
                    <td style="padding: 12px;">
                        <input type="checkbox" value="${product.id}" onchange="toggleProductSelection(${product.id})" ${selectedProducts.has(product.id) ? 'checked' : ''}>
                    </td>
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${product.image}" alt="${product.name}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600;">${product.name}</div>
                                <div class="small text-secondary">ID: ${product.id.toString().padStart(4, '0')}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px;">
                        <span class="label" style="background-color: var(--neutral-800); color: var(--neutral-200);">${product.category}</span>
                    </td>
                    <td style="padding: 12px; font-weight: 600; color: var(--primary-500);">${formatCurrency(product.price)}</td>
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${product.stock}</span>
                            ${getStockStatusIcon(product.stock)}
                        </div>
                    </td>
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--warning-500)" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                            </svg>
                            <span>${product.rating}</span>
                        </div>
                    </td>
                    <td style="padding: 12px;">
                        ${getStatusBadge(product)}
                    </td>
                    <td style="padding: 12px;">
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn icon-btn-sm" onclick="editProduct(${product.id})" title="Edit product">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="icon-btn icon-btn-sm" onclick="deleteProduct(${product.id})" title="Delete product">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            updateStatistics();
        }

        // Get stock status icon
        function getStockStatusIcon(stock) {
            if (stock === 0) {
                return '<svg width="16" height="16" viewBox="0 0 24 24" fill="var(--error-500)" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
            } else if (stock < 10) {
                return '<svg width="16" height="16" viewBox="0 0 24 24" fill="var(--warning-500)" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
            }
            return '<svg width="16" height="16" viewBox="0 0 24 24" fill="var(--success-500)" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
        }

        // Get status badge
        function getStatusBadge(product) {
            if (product.stock === 0) {
                return '<span class="label" style="background-color: var(--error-500); color: white;">Out of Stock</span>';
            } else if (product.stock < 10) {
                return '<span class="label" style="background-color: var(--warning-500); color: white;">Low Stock</span>';
            }
            return '<span class="label" style="background-color: var(--success-500); color: white;">In Stock</span>';
        }

        // Filter products
        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            const sort = document.getElementById('sortFilter').value;
            
            filteredProducts = products.filter(product => {
                // Search filter
                if (search) {
                    const matches = product.name.toLowerCase().includes(search) ||
                                  product.description.toLowerCase().includes(search) ||
                                  product.category.toLowerCase().includes(search) ||
                                  product.id.toString().includes(search);
                    if (!matches) return false;
                }
                
                // Category filter
                if (category && product.category !== category) {
                    return false;
                }
                
                // Status filter
                if (status) {
                    if (status === 'active' && product.stock === 0) return false;
                    if (status === 'inactive' && product.stock > 0) return false;
                    if (status === 'out-of-stock' && product.stock > 0) return false;
                }
                
                return true;
            });
            
            // Sort products
            filteredProducts.sort((a, b) => {
                switch(sort) {
                    case 'price-low':
                        return a.price - b.price;
                    case 'price-high':
                        return b.price - a.price;
                    case 'stock':
                        return a.stock - b.stock;
                    case 'rating':
                        return b.rating - a.rating;
                    case 'date':
                        return b.id - a.id;
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });
            
            currentPage = 1;
            displayProducts();
            updatePagination();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('productSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortFilter').value = 'name';
            filterProducts();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="icon-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15,18 9,12 15,6"/>
                    </svg>
                </button>
            `;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="icon-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span style="padding: 8px; color: var(--neutral-400);">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="icon-btn ${i === currentPage ? 'btn-primary' : ''}" onclick="goToPage(${i})">${i}</button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="padding: 8px; color: var(--neutral-400);">...</span>`;
                }
                paginationHTML += `<button class="icon-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `
                <button class="icon-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9,18 15,12 9,6"/>
                    </svg>
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayProducts();
                updatePagination();
            }
        }

        // Toggle product selection
        function toggleProductSelection(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            updateBulkActions();
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            
            if (selectAll.checked) {
                pageProducts.forEach(product => selectedProducts.add(product.id));
            } else {
                pageProducts.forEach(product => selectedProducts.delete(product.id));
            }
            
            displayProducts();
            updateBulkActions();
        }

        // Update bulk actions display
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const selectAll = document.getElementById('selectAll');
            
            if (selectedProducts.size > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = `${selectedProducts.size} product${selectedProducts.size !== 1 ? 's' : ''} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
            
            // Update select all checkbox
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            const pageSelectedCount = pageProducts.filter(p => selectedProducts.has(p.id)).length;
            
            selectAll.checked = pageSelectedCount === pageProducts.length && pageProducts.length > 0;
            selectAll.indeterminate = pageSelectedCount > 0 && pageSelectedCount < pageProducts.length;
        }

        // Clear selection
        function clearSelection() {
            selectedProducts.clear();
            displayProducts();
            updateBulkActions();
        }

        // Show add product modal
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('productModal').style.display = 'flex';
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            editingProductId = productId;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productFeatures').value = product.features.join('\n');
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productRating').value = product.rating;
            document.getElementById('productImage').value = product.image;
            
            // Show image preview if exists
            if (product.image) {
                document.getElementById('previewImg').src = product.image;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            document.getElementById('productModal').style.display = 'flex';
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        // Save product
        function saveProduct(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Get form values
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                features: document.getElementById('productFeatures').value.split('\n').filter(f => f.trim()),
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                rating: parseFloat(document.getElementById('productRating').value) || 4.0,
                image: document.getElementById('productImage').value || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=400&fit=crop'
            };
            
            // Show loading
            const saveBtn = document.getElementById('saveProductBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtnLoading = document.getElementById('saveBtnLoading');
            
            saveBtn.disabled = true;
            saveBtnText.style.display = 'none';
            saveBtnLoading.style.display = 'inline-block';
            
            // Simulate save delay
            setTimeout(() => {
                try {
                    if (editingProductId) {
                        // Update existing product
                        const index = products.findIndex(p => p.id === editingProductId);
                        if (index !== -1) {
                            products[index] = { ...products[index], ...productData };
                        }
                        showNotification('Product updated successfully', 'success');
                    } else {
                        // Add new product
                        const newProduct = {
                            id: Math.max(...products.map(p => p.id)) + 1,
                            reviews: 0,
                            ...productData
                        };
                        products.push(newProduct);
                        showNotification('Product added successfully', 'success');
                    }
                    
                    loadProducts();
                    closeProductModal();
                    
                    trackEvent('product_saved', {
                        productId: editingProductId,
                        isNew: !editingProductId,
                        user: currentUser.email
                    });
                    
                } catch (error) {
                    console.error('Error saving product:', error);
                    showNotification('Error saving product', 'error');
                } finally {
                    // Reset button state
                    saveBtn.disabled = false;
                    saveBtnText.style.display = 'inline';
                    saveBtnLoading.style.display = 'none';
                }
            }, 1000);
        }

        // Delete product
        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            window.deleteProductId = productId;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        // Confirm delete
        function confirmDelete() {
            const productId = window.deleteProductId;
            const product = products.find(p => p.id === productId);
            
            // Remove product
            products = products.filter(p => p.id !== productId);
            
            // Remove from selected products if selected
            selectedProducts.delete(productId);
            
            loadProducts();
            updateBulkActions();
            closeDeleteModal();
            
            showNotification(`Product "${product.name}" deleted successfully`, 'success');
            
            trackEvent('product_deleted', {
                productId: productId,
                productName: product.name,
                user: currentUser.email
            });
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            window.deleteProductId = null;
        }

        // Bulk delete
        function bulkDelete() {
            if (selectedProducts.size === 0) return;
            
            if (confirm(`Are you sure you want to delete ${selectedProducts.size} products?`)) {
                products = products.filter(p => !selectedProducts.has(p.id));
                selectedProducts.clear();
                
                loadProducts();
                updateBulkActions();
                
                showNotification(`${selectedProducts.size} products deleted successfully`, 'success');
                
                trackEvent('bulk_products_deleted', {
                    count: selectedProducts.size,
                    user: currentUser.email
                });
            }
        }

        // Bulk export
        function bulkExport() {
            const selectedProductsData = products.filter(p => selectedProducts.has(p.id));
            exportData(selectedProductsData, 'selected_products');
        }

        // Export products
        function exportProducts(format) {
            const data = format === 'csv' ? convertToCSV(products) : JSON.stringify(products, null, 2);
            const filename = `products.${format}`;
            downloadFile(data, filename, format === 'csv' ? 'text/csv' : 'application/json');
            
            showNotification(`Products exported as ${format.toUpperCase()}`, 'success');
            
            trackEvent('products_exported', {
                format: format,
                count: products.length,
                user: currentUser.email
            });
        }

        // Convert to CSV
        function convertToCSV(data) {
            const headers = ['ID', 'Name', 'Category', 'Price', 'Stock', 'Rating', 'Description'];
            const rows = data.map(product => [
                product.id,
                product.name,
                product.category,
                product.price,
                product.stock,
                product.rating,
                `"${product.description.replace(/"/g, '""')}"`
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // Download file
        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Update statistics
        function updateStatistics() {
            const totalProducts = products.length;
            const activeProducts = products.filter(p => p.stock > 0).length;
            const lowStockProducts = products.filter(p => p.stock > 0 && p.stock < 10).length;
            const outOfStockProducts = products.filter(p => p.stock === 0).length;
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('activeProducts').textContent = activeProducts;
            document.getElementById('lowStockProducts').textContent = lowStockProducts;
            document.getElementById('outOfStockProducts').textContent = outOfStockProducts;
        }

        // Handle image upload
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image size must be less than 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('productImage').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Utility functions
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            localStorage.setItem('dx_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        // Load theme preference
        const savedTheme = localStorage.getItem('dx_theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }

        console.log('ðŸ“¦ Product Management System loaded!');
        console.log('ðŸ”§ Enterprise CRUD operations ready');
        console.log('ðŸ“Š Bulk actions and analytics available');
        console.log('ðŸ’± Philippine Peso product pricing');
    </script>
</body>
</html>